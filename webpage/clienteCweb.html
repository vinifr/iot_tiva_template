<!DOCTYPE html>
<html>
<head>
    <title>Websocket client</title>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="page-header">Websocket client</h1>

        <form action="" class="form-inline" id="connectForm">
            <div class="input-append">
                <input type="text" class="input-large" value="ws://192.168.25.12" id="wsServer">
                <button class="btn" type="submit" id="connect">Connect</button>
                <button class="btn" disabled="disabled" id="disconnect">Disconnect</button>
            </div>
        </form>
        <form action="" id="sendForm">
            <div class="input-append">
                <input class="input-large" type="text" placeholder="message" id="message" disabled="disabled">
                <button class="btn btn-primary" type="submit" id="send" disabled="disabled">send</button>
            </div>
        </form>
        <hr>
        <ul class="unstyled" id="log"></ul>
    </div>
    
    
    
    <script type="text/javascript">
	var recv = new Array(512);
	var id;
        $(document).ready(function() {
            var ws;
            $('#connectForm').on('submit', function() {
                if ("WebSocket" in window) {
                    ws = new WebSocket($('#wsServer').val());
                    ws.onopen = function() {
                        $('#log').append('<li><span class="badge badge-success">websocket opened</span></li>');
                        $('#wsServer').attr('disabled', 'disabled');
                        $('#connect').attr('disabled', 'disabled');
                        $('#disconnect').removeAttr('disabled');
                        $('#message').removeAttr('disabled').focus();
                        $('#send').removeAttr('disabled');
                    };
                    ws.onerror = function() {
                        $('#log').append('<li><span class="badge badge-important">websocket error</span></li>');
                    };
                    ws.onmessage = function(event) {
                        $('#log').append('<li>recieved: <span class="badge">' + event.data + '</span></li>');
                        recv[id] = event.data;
                    };
                    ws.onclose = function() {
                        $('#log').append('<li><span class="badge badge-important">websocket closed</span></li>');
                        $('#wsServer').removeAttr('disabled');
                        $('#connect').removeAttr('disabled');
                        $('#disconnect').attr('disabled', 'disabled');
                        $('#message').attr('disabled', 'disabled');
                        $('#send').attr('disabled', 'disabled');
                    };
                } else {
                    $('#log').append('<li><span class="badge badge-important">WebSocket NOT supported in this browser</span></li>');
                }
                return false;
            });
            $('#sendForm').on('submit', function() {
                var message = $('#message').val();
                ws.send(message);
                $('#log').append('<li>sended: <span class="badge">' + message + '</span></li>');
                return false;
            });
            $('#disconnect').on('click', function() {
                ws.close();
                return false;
            });
        });
        
        // Plot ADC values received
        // Heart Monitor Audio
	var audio = new Audio('http://www.dallasjclark.com/wordpress/wp-content/uploads/2016/05/Heart-Rate-Monitor.mp3');
	var audioPlayed = false;

	// Full Height and Width
	var canvasHeight = $(document).height() / 2;
	var canvasWidth = $(document).width() / 2;

	// Create Canvas Element
	var canvas = document.createElement('canvas');
	canvas.width = canvasWidth;
	canvas.height = canvasHeight;
	document.body.appendChild(canvas);

	// Context
	var context = canvas.getContext('2d');
	context.save();

	// Stroke Positions
	strokePositionX = 0;
	strokePositionY = canvasHeight / 2;

	/**
	* Render the Background Screen
	*/
	function renderBackgroundScreen (alpha) {
	    context.beginPath();
	    context.fillStyle = 'rgba(20, 20, 20, ' + alpha + ')';
	    context.fillRect(0, 0, canvasWidth, canvasHeight);
	    context.closePath();

	    context.beginPath();

	    for (var j = 20; j < canvasHeight; j = j + 20) {
		context.moveTo(0, j);
		context.lineTo(canvasWidth, j);
	    }
	    
	    for (var i = 20; i < canvasWidth; i = i + 20) {
		context.moveTo(i, 0);
		context.lineTo(i, canvasHeight);
	    }
	    
	    context.lineWidth = 1;
	    context.strokeStyle = 'rgba(20, 50, 20, ' + alpha + ')';
	    context.stroke();
	    context.closePath();
	}

	/**
	* Draws the Heart Monitor Stroke
	*/
	function drawHeartMonitorStroke () {
	    context.restore();
	    
	    renderBackgroundScreen(0.02);

	    context.beginPath();
	    context.moveTo(strokePositionX, strokePositionY);
	    strokePositionX = strokePositionX + 1;

	    strokePositionY = Math.sin(strokePositionX / 10) * 70 + recv[id++];
	    if (id >= 512)
		id = 0;

	    if ((strokePositionX >= canvasWidth * 20 / 100 && strokePositionX < canvasWidth * 24 / 100)
	    || (strokePositionX >= canvasWidth * 70 / 100 && strokePositionX < canvasWidth * 74 / 100)) {
		// Test audio has not been played
		if (!audioPlayed) {
		    //audio.play();
		    audioPlayed = true;
		}
		//strokePositionY = strokePositionY - canvasHeight / 100;
	    }

	    else if ((strokePositionX >= canvasWidth * 24 / 100 && strokePositionX < canvasWidth * 32 / 100)
	    || (strokePositionX >= canvasWidth * 74 / 100 && strokePositionX < canvasWidth * 82 / 100)) {
		strokePositionY = strokePositionY + canvasHeight / 100;

		// Reset Audio Played flag
		audioPlayed = false;
	    }

	    else if ((strokePositionX >= canvasWidth * 32 / 100 && strokePositionX < canvasWidth * 36 / 100)
	    || (strokePositionX >= canvasWidth * 82 / 100 && strokePositionX < canvasWidth * 86 / 100)) {
		//strokePositionY = strokePositionY - canvasHeight / 100;
	    }

	    else if ((strokePositionX >= canvasWidth * 36 / 100 && strokePositionX < canvasWidth * 60 / 100)
	    || (strokePositionX >= canvasWidth * 86 / 100 && strokePositionX <= canvasWidth)) {
		//strokePositionY = canvasHeight / 2;
	    }

	    else if (strokePositionX > canvasWidth) {
		strokePositionX = 0;
		context.moveTo(strokePositionX, strokePositionY);
	    }

	    context.lineTo(strokePositionX, strokePositionY);
	    context.lineWidth = 2;
	    context.strokeStyle = '#47FF47';
	    context.stroke();
	    context.closePath();
	}

	renderBackgroundScreen(1);
	setInterval(drawHeartMonitorStroke, 1);
    </script>

</body>
</html>