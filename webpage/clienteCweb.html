<!DOCTYPE html>
<html>
<head>
    <title>Websocket client</title>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="page-header">Websocket client</h1>

        <form action="" class="form-inline" id="connectForm">
            <div class="input-append">
                <input type="text" class="input-large" value="ws://192.168.25.15" id="wsServer">
                <button class="btn" type="submit" id="connect">Connect</button>
                <button class="btn" disabled="disabled" id="disconnect">Disconnect</button>
            </div>
        </form>
        <form action="" id="sendForm">
            <div class="input-append">
                <input class="input-large" type="text" placeholder="message" id="message" disabled="disabled">
                <button class="btn btn-primary" type="submit" id="send" disabled="disabled">send</button>
            </div>
        </form>
        <hr>
        <ul class="unstyled" id="log"></ul>
    </div>
    
    
    
    <script type="text/javascript">
	var str;
	var ws;
	var isOpen = false;
	var isReady = false;
        $(document).ready(function() {
            //var ws;
            $('#connectForm').on('submit', function() {
                if ("WebSocket" in window) {
                    ws = new WebSocket($('#wsServer').val());
                    ws.onopen = function() {
                        $('#log').append('<li><span class="badge badge-success">websocket opened</span></li>');
                        $('#wsServer').attr('disabled', 'disabled');
                        $('#connect').attr('disabled', 'disabled');
                        $('#disconnect').removeAttr('disabled');
                        $('#message').removeAttr('disabled').focus();
                        $('#send').removeAttr('disabled');
                        isOpen = true;
                    };
                    ws.onerror = function() {
                        $('#log').append('<li><span class="badge badge-important">websocket error</span></li>');
                    };
                    ws.onmessage = function(event) {
                        //$('#log').append('<li>recieved: <span class="badge">' + event.data + '</span></li>');
                        //console.log('<li>recieved: <span class="badge">' + event.data + '</span></li>');
                        str = event.data;
                        isReady = true;
                    };
                    ws.onclose = function() {
                        $('#log').append('<li><span class="badge badge-important">websocket closed</span></li>');
                        $('#wsServer').removeAttr('disabled');
                        $('#connect').removeAttr('disabled');
                        $('#disconnect').attr('disabled', 'disabled');
                        $('#message').attr('disabled', 'disabled');
                        $('#send').attr('disabled', 'disabled');
                        isOpen = false;
                    };
                } else {
                    $('#log').append('<li><span class="badge badge-important">WebSocket NOT supported in this browser</span></li>');
                }
                return false;
            });
            $('#sendForm').on('submit', function() {
                var message = $('#message').val();
                ws.send(message);
                $('#log').append('<li>sended: <span class="badge">' + message + '</span></li>');
                return false;
            });
            $('#disconnect').on('click', function() {
                ws.close();
                isOpen = false;
                return false;
            });
        });
        
        // Plot ADC values received
        // Heart Monitor Audio
	//var audio = new Audio('http://www.dallasjclark.com/wordpress/wp-content/uploads/2016/05/Heart-Rate-Monitor.mp3');
	//var audioPlayed = false;

	// Full Height and Width
	var canvasHeight = $(document).height() / 2;
	var canvasWidth = $(document).width() / 2;

	// Create Canvas Element
	var canvas = document.createElement('canvas');
	canvas.width = canvasWidth;
	canvas.height = canvasHeight;
	document.body.appendChild(canvas);

	// Context
	var context = canvas.getContext('2d');
	context.save();

	// Stroke Positions
	strokePositionX = 0;
	strokePositionY = canvasHeight / 2;

	/* Funcao map() do Arduino: http://renatoaloi.blogspot.com.br/2013/12/funcao-map-do-arduino.html
	long map(long x, long in_min, long in_max, long out_min, long out_max)
	{
	return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
	}
	*/
	function map(x, in_min, in_max, out_min, out_max) {
	    return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
	}

	/**
	* Render the Background Screen
	*/
	function renderBackgroundScreen (alpha) {
	    context.beginPath();
	    context.fillStyle = 'rgba(20, 20, 20, ' + alpha + ')';
	    context.fillRect(0, 0, canvasWidth, canvasHeight);
	    context.closePath();

	    context.beginPath();

	    for (var j = 20; j < canvasHeight; j = j + 20) {
		context.moveTo(0, j);
		context.lineTo(canvasWidth, j);
	    }
	    
	    for (var i = 20; i < canvasWidth; i = i + 20) {
		context.moveTo(i, 0);
		context.lineTo(i, canvasHeight);
	    }
	    
	    context.lineWidth = 1;
	    context.strokeStyle = 'rgba(20, 50, 20, ' + alpha + ')';
	    context.stroke();
	    context.closePath();
	}

	/**
	* Draws the Heart Monitor Stroke
	*/
	function drawHeartMonitorStroke () {
	    context.restore();
	    
	    renderBackgroundScreen(0.02);
	    if (isOpen == true) {
			ws.send('{"jsonrpc": "2.0", "method": "sendADC", "params": [1], "id": 1}');
		}

	    context.beginPath();
	    context.moveTo(strokePositionX, strokePositionY);
	    strokePositionX = strokePositionX + 1.0;

	    //strokePositionY = Math.sin(strokePositionX / 10) * 70 + 100;
	    if (isReady == true) {
		isReady = false;
		//strokePositionY = recv[j];
		var index = str.indexOf("result")
		var value = str.substring(index+9, index+12);
		var rawVal = parseInt(value);
		var tensao = ((rawVal * 3.3)/4096);
		//console.log('ADC value: ' + rawVal);
		//console.log('Heart: ' + (tensao));
		//console.log('Temperatura: ' + (tensao * 100));
		//strokePositionY = recv[j++] * 100;
		if (!tensao)
			strokePositionY = tensao * 1000;
		else
			strokePositionY = canvasHeight / 2;
		//tensao *= 100;

		//Map and draw the line for new data point
		//var inByte = map(tensao, 0, 4095, 0, canvasHeight);
		//strokePositionY = canvasHeight - inByte;//var height_new = canvasHeight - inByte;
		//line(xPos - 1, height_old, xPos, height_new);
		//height_old = height_new;
	    } else
		strokePositionY = canvasHeight / 2;
	    
	    
	    if (strokePositionX > canvasWidth) {
		strokePositionX = 0;
		context.moveTo(strokePositionX, strokePositionY);
	    }

	    context.lineTo(strokePositionX, strokePositionY);
	    context.lineWidth = 2;
	    context.strokeStyle = '#47FF47';
	    context.stroke();
	    context.closePath();
	}

	renderBackgroundScreen(1);
	setInterval(drawHeartMonitorStroke, 10);
    </script>

</body>
</html>